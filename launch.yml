---
 - name: Launch compute instance
   hosts: localhost
   vars_files:
    - vars.yml
   tasks:
   - name: download ubuntu image
     get_url:
      dest: ./images/xenial-server-cloudimg-amd64-disk1.img
      url: http://cloud-images.ubuntu.com/xenial/current/xenial-server-cloudimg-amd64-disk1.img
     register: get_ubuntu

   - debug:
      msg="ubuntu was downloaded"
     when: get_ubuntu|changed

   #- name: Create ssh key
   #  command: ssh-keygen -t rsa -b 1024 -G ./id_rsa
   #  register: get_key
   
   #- debug:
   #   msg="key already exists"
   #  when: get_key|changed
   
   #- name: Create keypair
   #  os_keypair:
   #   name: mykey
   #   auth:
   #     auth_url: "{{ url }}"
   #     username: "{{ user }}"
   #     password: "{{ pass }}"
   #     project_name: admin
   #   state: present
   #   public_key_file: ./mykey.pem


   #- name: upload linux image to glance
   #  os_image:
   #   auth: 
   #     auth_url: "{{ url }}"
   #     username: "{{ user }}"
   #     password: "{{ pass }}"
   #   name: ubuntu_xenial
   #   is_public: yes
   #   filename: ./images/xenial-server-cloudimg-amd64-disk1.img
    
   
   - name: launch an instance with ubuntu
     os_server:
      auth: 
        auth_url: "{{ url }}"
        username: "{{ user }}"
        password: "{{ pass }}"
        project_name: admin
      image: ubuntu_xenial
      name: small_server
      key_name: ./mykey.pem
      timeout: 200
      flavor: 2
      state: present
      auto_ip: yes