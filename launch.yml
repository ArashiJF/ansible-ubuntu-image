---
 - name: Launch compute instance
   hosts: localhost
   vars_files:
    - vars.yml
   tasks:
     - name: download ubuntu image
        get_url:
          dest: images/xenial-server-cloud-amd64.qcow2
          url: http://cloud-images.ubuntu.com/xenial/current/xenial-server-cloudimg-amd64-disk1.img
 
     - name: upload linux image to glance
        os_image:
          auth: 
            auth_url: "{{ url }}"
            username: "{{ name }}"
            password: "{{ pass }}"
          name: ubuntu_xenial
          is_public: yes
          filename: images/xenial-server-cloud-amd64.qcow2
    
      - name: Create ssh key
        command: ssh-keygen

      - name: Create keypar
       os_keypar:
        name: mykey
        auth:
          auth_url: "{{ url }}"
          username: "{{ name }}"
          password: "{{ pass }}"
          project_name: admin
        state: present
        public_key_file: /home/stack/.ssh/id_rsa.pub

        - name: launch an instance with ubuntu
         os_server:
          auth: 
            auth_url: "{{ url }}"
            username: "{{ name }}"
            password: "{{ pass }}"
          image: ubuntu_xenial
          name: small_server
          key_name: PUBKEY
          timeout: 200
          flavor: 2
          state: present
          auto_ip: yes  